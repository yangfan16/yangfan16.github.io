<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/uploads/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16.png"><link rel="mask-icon" href="/uploads/safari-pinned-tab.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"blog.yangfan16.cn",root:"/",scheme:"Mist",version:"7.8.0",exturl:!1,sidebar:{position:"right",display:"hide",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!0,lazyload:!0,pangu:!0,comments:{style:"buttons",active:"gitalk",storage:!0,lazyload:!1,nav:null,activeClass:"gitalk"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!0,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta property="og:type" content="website"><meta property="og:title" content="青梅梦呓"><meta property="og:url" content="https://blog.yangfan16.cn/index.html"><meta property="og:site_name" content="青梅梦呓"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="青梅煮马"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://blog.yangfan16.cn/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>青梅梦呓</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">青梅梦呓</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">和世界交手的这许多年，你是否光彩依旧，兴致盎然</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i> 关于</a></li></ul></nav></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/yangfan16" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.yangfan16.cn/go/go-conns-pool/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="青梅煮马"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="青梅梦呓"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/go/go-conns-pool/" class="post-title-link" itemprop="url">Go实现通用网络连接池</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-08-22 22:19:14" itemprop="dateCreated datePublished" datetime="2020-08-22T22:19:14+08:00">2020-08-22</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>8.5k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>8 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>连接池在羡慕开发中是经常见到的，因为TCP的三次握手等原因，建立一个连接算是一个比较高的开销，而频繁的创建和销毁连接会带来严重的性能下降，所以在一个需要多次与特定实体交互的程序中，就需要维持一个连接池，里面有可以复用的连接可供重复使用。</p></blockquote><blockquote><p>PS: 今天在面试中被要求手写一个通用连接池，紧张之下表现的一塌糊涂，回来之后查缺补漏，增补记录以作后续提成</p></blockquote><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="什么是连接池"><a href="#什么是连接池" class="headerlink" title="什么是连接池"></a>什么是连接池</h3><ul><li>顾名思义是一个池子</li><li>池子里面存放有限数量即时可用的连接，减少创建连接和关闭连接的时间</li><li>连接是有存活时间的</li></ul><p>以数据库连接池为例，可以简单画一张流程图表示连接池的生命周期：</p><p><img data-src="https://images.yangfan16.cn/%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%A3%B0%E6%98%8E%E5%91%A8%E6%9C%9F.jpg" alt="连接池的生命周期"></p><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>gorm是复用database/sql的连接池,redigo是自己维护了一个连接池,<a href="https://github.com/gomodule/redigo/blob/master/redis/pool.go" target="_blank" rel="noopener">代码参考这里</a>。实现一个通用的网络连接池，连接池的实现不依赖具体的实例，而依赖一个接口，只要实现了接口的对象都可以被池管理。<br>Ps: 实现基于<code>interface{}</code>的连接池，这样任何对象都可以被池管理。</p><h3 id="功能与要求"><a href="#功能与要求" class="headerlink" title="功能与要求"></a>功能与要求</h3><ul><li>线程安全 thread safe</li><li>获取连接，释放连接</li><li>连接池中连接类型为interface{}，使得更加通用</li><li>支撑连接的最大空闲时间，超时的连接将关闭丢弃，可避免空闲时连接自动失效问题</li><li>设置最大连接数，连接池的容量，连接存活时间等等</li><li>支持用户设定ping方法，检查连接的连通性，无效的连接将丢弃</li><li>使用channel处理池中的连接，高效</li></ul><h3 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a>实现细节</h3><ul><li>确定连接池的属性: 如最大连接数、容量、连接创建时间和存活时间</li><li>拟使用连接池以及超过最大连接数后等待其他连接释放</li><li>保证在多协程操作下数据的一致性</li><li>最好实现连接的超时监听和通知</li></ul><h2 id="调研"><a href="#调研" class="headerlink" title="调研"></a>调研</h2><p> gorm复用的是<code>database/sql连接池</code>,redigo维护了一个自己的连接池，但是两者的实现都很复杂，移植代码的成本过高。fatih大神有一个<code>pool</code>库，<a href="https://github.com/fatih/pool/tree/v3.0.0" target="_blank" rel="noopener">具体移步这里</a>，遗憾的是该项目目前已经不再维护，<a href="https://pkg.go.dev/mod/gopkg.in/fatih/pool.v3" target="_blank" rel="noopener">具体文档在此</a>。最后一个版本也没有实现主动检查连接超时、MaxIdle配置，还有MaxConn，算是一个半成品，就基于fatih大神的这个库进行再次开发</p><h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><h3 id="定义Pool-interface"><a href="#定义Pool-interface" class="headerlink" title="定义Pool interface"></a>定义Pool interface</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pool</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pool <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Get 从连接池中获取一个连接</span></span><br><span class="line">	Get() (<span class="keyword">interface</span>&#123;&#125;, error)</span><br><span class="line">	<span class="comment">// Put 连接放回连接池中</span></span><br><span class="line">	Put(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">	<span class="comment">// Close 关闭连接</span></span><br><span class="line">	Close(<span class="keyword">interface</span>&#123;&#125;) error</span><br><span class="line">	<span class="comment">// Release 释放连接池中的所有连接</span></span><br><span class="line">	Release()</span><br><span class="line">	<span class="comment">// Len 查看当前连接迟中的连接数量</span></span><br><span class="line">	Len()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="定义连接池相关配置"><a href="#定义连接池相关配置" class="headerlink" title="定义连接池相关配置"></a>定义连接池相关配置</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">	InitialCap  <span class="keyword">int</span>                         <span class="comment">//连接池中的最小连接数</span></span><br><span class="line">	MaxCap      <span class="keyword">int</span>                         <span class="comment">//最大的并发存活连接数</span></span><br><span class="line">	MaxIdle     <span class="keyword">int</span>                         <span class="comment">//最大存活连接数</span></span><br><span class="line">	Factory     <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span> //生成连接的方法</span></span><br><span class="line">	Close       <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>     //关闭连接的方法</span></span><br><span class="line">	Ping        <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>     //检查连接是否有效的方法</span></span><br><span class="line">	IdleTimeout time.Duration               <span class="comment">//连接最大空闲时间，超过该时间则连接失效</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p> 将连接句柄放入channel中，由于缓冲channel的特性，获取连接时，如果连接池中满足直接返回连接的情况时将直接返回，否则将阻塞等待或者直接创建新的连接，因此需要定义通用连接:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> idleConn <span class="keyword">struct</span> &#123;</span><br><span class="line">	conn <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	t    time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> connReq <span class="keyword">struct</span> &#123;</span><br><span class="line">	idleConnect *idleConn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GenericPool <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="keyword">type</span> GenericPool <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu                 sync.RWMutex                <span class="comment">//锁</span></span><br><span class="line">	connections        <span class="keyword">chan</span> *idleConn              <span class="comment">//channel 为包装后的类型，包含连接和时间</span></span><br><span class="line">	factory            <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span> //创建连接的方法</span></span><br><span class="line">	<span class="built_in">close</span>              <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>     //关闭连接的方法</span></span><br><span class="line">	ping               <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>     //检查连接的放大</span></span><br><span class="line">	idleTimeout        time.Duration               <span class="comment">//连接最大空闲时间</span></span><br><span class="line">	waitTimeout        time.Duration               <span class="comment">//等待超时时间</span></span><br><span class="line">	maxActive          <span class="keyword">int</span>                         <span class="comment">//最大存活连接数</span></span><br><span class="line">	openingConnections <span class="keyword">int</span></span><br><span class="line">	connRequests       []<span class="keyword">chan</span> connReq</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单包装了一些，在fatih大神的基础上增加了连接池常用的一些属性</p><h3 id="初始化连接池"><a href="#初始化连接池" class="headerlink" title="初始化连接池"></a>初始化连接池</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGenericPool</span><span class="params">(config *Config)</span> <span class="params">(Pool, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">//初始容量判断</span></span><br><span class="line">	<span class="keyword">if</span> !(config.InitialCap &lt;= config.MaxIdle &amp;&amp; config.MaxCap &gt;= config.MaxIdle &amp;&amp; config.InitialCap &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"invalid capacity settings"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//必须有创建方法</span></span><br><span class="line">	<span class="keyword">if</span> config.Factory == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"invalid factory func settings"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> config.Close == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"invalid close func settings"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	genericPool := &amp;GenericPool&#123;</span><br><span class="line">		connections:        <span class="built_in">make</span>(<span class="keyword">chan</span> *idleConn, config.MaxIdle),</span><br><span class="line">		factory:            config.Factory,</span><br><span class="line">		<span class="built_in">close</span>:              config.Close,</span><br><span class="line">		idleTimeout:        config.IdleTimeout,</span><br><span class="line">		maxActive:          config.MaxCap,</span><br><span class="line">		openingConnections: config.InitialCap,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> config.Ping != <span class="literal">nil</span> &#123;</span><br><span class="line">		genericPool.ping = config.Ping</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; config.InitialCap; i++ &#123;</span><br><span class="line">		conn, err := genericPool.factory()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			genericPool.Release()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"factory is not able to fill the pool: %s"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		genericPool.connections &lt;- &amp;idleConn&#123;conn: conn, t: time.Now()&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> genericPool, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个代码很简单，基本就是常见的应用，唯一的问题就是函数签名中返回的是Pool类型，实际返回的是一个<code>genericPool</code>的实例化对象，只要实现我们之前定义的接口的方法即可。</p><h3 id="实现接口后的完整代码"><a href="#实现接口后的完整代码" class="headerlink" title="实现接口后的完整代码"></a>实现接口后的完整代码</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"errors"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	ErrClosed               = errors.New(<span class="string">"pool is closed"</span>)</span><br><span class="line">	ErrMaxActiveConnReached = errors.New(<span class="string">"MaxActiveConnReached"</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">	InitialCap  <span class="keyword">int</span>                         <span class="comment">//连接池中的最小连接数</span></span><br><span class="line">	MaxCap      <span class="keyword">int</span>                         <span class="comment">//最大的并发存活连接数</span></span><br><span class="line">	MaxIdle     <span class="keyword">int</span>                         <span class="comment">//最大存活连接数</span></span><br><span class="line">	Factory     <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span> //生成连接的方法</span></span><br><span class="line">	Close       <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>     //关闭连接的方法</span></span><br><span class="line">	Ping        <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>     //检查连接是否有效的方法</span></span><br><span class="line">	IdleTimeout time.Duration               <span class="comment">//连接最大空闲时间，超过该时间则连接失效</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> idleConn <span class="keyword">struct</span> &#123;</span><br><span class="line">	conn <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	t    time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> connReq <span class="keyword">struct</span> &#123;</span><br><span class="line">	idleConnect *idleConn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GenericPool <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu                 sync.RWMutex                <span class="comment">//锁</span></span><br><span class="line">	connections        <span class="keyword">chan</span> *idleConn              <span class="comment">//channel 为包装后的类型，包含连接和时间</span></span><br><span class="line">	factory            <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span> //创建连接的方法</span></span><br><span class="line">	<span class="built_in">close</span>              <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>     //关闭连接的方法</span></span><br><span class="line">	ping               <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span>     //检查连接的放大</span></span><br><span class="line">	idleTimeout        time.Duration               <span class="comment">//连接最大空闲时间</span></span><br><span class="line">	waitTimeout        time.Duration               <span class="comment">//等待超时时间</span></span><br><span class="line">	maxActive          <span class="keyword">int</span>                         <span class="comment">//最大存活连接数</span></span><br><span class="line">	openingConnections <span class="keyword">int</span></span><br><span class="line">	connRequests       []<span class="keyword">chan</span> connReq</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ping 检查连接状态</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GenericPool)</span> <span class="title">Ping</span><span class="params">(conn <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> conn == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"connection is nil. rejecting"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> g.ping(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getConnections 获取所有连接</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GenericPool)</span> <span class="title">getConnections</span><span class="params">()</span> <span class="title">chan</span> *<span class="title">idleConn</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> g.mu.Unlock()</span><br><span class="line">	g.mu.Lock()</span><br><span class="line">	<span class="keyword">return</span> g.connections</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取连接</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GenericPool)</span> <span class="title">Get</span><span class="params">()</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">	connections := g.getConnections()</span><br><span class="line">	<span class="keyword">if</span> connections == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrClosed</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> wrapConn := &lt;-connections:</span><br><span class="line">			<span class="keyword">if</span> wrapConn == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, ErrClosed</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//还要判断这个链接的存活时间是否超过了最大允许存活时间</span></span><br><span class="line">			<span class="keyword">if</span> g.idleTimeout &gt; <span class="number">0</span> &amp;&amp; wrapConn.t.Add(g.idleTimeout).Before(time.Now()) &#123;</span><br><span class="line">				<span class="comment">//丢弃并关闭该连接</span></span><br><span class="line">				g.Close(wrapConn.conn)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 判断是否失效，失效则丢弃，如果用户没有设定 ping 方法，就不检查</span></span><br><span class="line">			<span class="keyword">if</span> g.ping != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> err := g.Ping(wrapConn.conn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="comment">//丢弃并关闭该连接</span></span><br><span class="line">					g.Close(wrapConn.conn)</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> wrapConn, <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			g.mu.Lock()</span><br><span class="line">			<span class="keyword">if</span> g.openingConnections &gt;= g.maxActive &#123;</span><br><span class="line">				req := <span class="built_in">make</span>(<span class="keyword">chan</span> connReq, <span class="number">1</span>)</span><br><span class="line">				g.connRequests = <span class="built_in">append</span>(g.connRequests, req)</span><br><span class="line">				<span class="comment">// 不在循环中使用defer  避免造成内存泄漏</span></span><br><span class="line">				g.mu.Unlock()</span><br><span class="line">				ret, ok := &lt;-req</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, ErrMaxActiveConnReached</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> g.idleTimeout &gt; <span class="number">0</span> &amp;&amp; ret.idleConnect.t.Add(g.idleTimeout).Before(time.Now()) &#123;</span><br><span class="line">					<span class="comment">//丢弃并关闭该连接</span></span><br><span class="line">					g.Close(ret.idleConnect.conn)</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> ret.idleConnect.conn, <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> g.factory == <span class="literal">nil</span> &#123;</span><br><span class="line">				g.mu.Unlock()</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, ErrClosed</span><br><span class="line">			&#125;</span><br><span class="line">			conn, err := g.factory()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				g.mu.Unlock()</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			g.openingConnections++</span><br><span class="line">			g.mu.Unlock()</span><br><span class="line">			<span class="keyword">return</span> conn, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GenericPool)</span> <span class="title">Put</span><span class="params">(conn <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> conn == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"connection is nil. rejecting"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	g.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> g.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> g.connections == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> g.Close(conn)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> l := <span class="built_in">len</span>(g.connRequests); l &gt; <span class="number">0</span> &#123;</span><br><span class="line">		req := g.connRequests[<span class="number">0</span>]</span><br><span class="line">		<span class="built_in">copy</span>(g.connRequests, g.connRequests[<span class="number">1</span>:])</span><br><span class="line">		g.connRequests = g.connRequests[:l<span class="number">-1</span>]</span><br><span class="line">		req &lt;- connReq&#123;</span><br><span class="line">			idleConnect: &amp;idleConn&#123;conn: conn, t: time.Now()&#125;,</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> g.connections &lt;- &amp;idleConn&#123;conn: conn, t: time.Now()&#125;:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">//连接池已满，直接关闭该连接</span></span><br><span class="line">			<span class="keyword">return</span> g.Close(conn)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GenericPool)</span> <span class="title">Close</span><span class="params">(conn <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> conn == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"connection is nil. rejecting"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	g.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> g.mu.Unlock()</span><br><span class="line">	<span class="keyword">if</span> g.<span class="built_in">close</span> == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	g.openingConnections--</span><br><span class="line">	<span class="keyword">return</span> g.<span class="built_in">close</span>(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GenericPool)</span> <span class="title">Release</span><span class="params">()</span></span> &#123;</span><br><span class="line">	g.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> g.mu.Unlock()</span><br><span class="line">	connections := g.connections</span><br><span class="line">	g.connections = <span class="literal">nil</span></span><br><span class="line">	g.factory = <span class="literal">nil</span></span><br><span class="line">	g.ping = <span class="literal">nil</span></span><br><span class="line">	closeFun := g.<span class="built_in">close</span></span><br><span class="line">	g.<span class="built_in">close</span> = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> connections == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">close</span>(connections)</span><br><span class="line">	<span class="keyword">for</span> wrapConn := <span class="keyword">range</span> connections &#123;</span><br><span class="line">		_ = closeFun(wrapConn.conn)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GenericPool)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(g.getConnections())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewGenericPool 初始化连接池</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGenericPool</span><span class="params">(config *Config)</span> <span class="params">(Pool, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">//初始容量判断</span></span><br><span class="line">	<span class="keyword">if</span> !(config.InitialCap &lt;= config.MaxIdle &amp;&amp; config.MaxCap &gt;= config.MaxIdle &amp;&amp; config.InitialCap &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"invalid capacity settings"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//必须有创建方法</span></span><br><span class="line">	<span class="keyword">if</span> config.Factory == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"invalid factory func settings"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> config.Close == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"invalid close func settings"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	genericPool := &amp;GenericPool&#123;</span><br><span class="line">		connections:        <span class="built_in">make</span>(<span class="keyword">chan</span> *idleConn, config.MaxIdle),</span><br><span class="line">		factory:            config.Factory,</span><br><span class="line">		<span class="built_in">close</span>:              config.Close,</span><br><span class="line">		idleTimeout:        config.IdleTimeout,</span><br><span class="line">		maxActive:          config.MaxCap,</span><br><span class="line">		openingConnections: config.InitialCap,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> config.Ping != <span class="literal">nil</span> &#123;</span><br><span class="line">		genericPool.ping = config.Ping</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; config.InitialCap; i++ &#123;</span><br><span class="line">		conn, err := genericPool.factory()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			genericPool.Release()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"factory is not able to fill the pool: %s"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		genericPool.connections &lt;- &amp;idleConn&#123;conn: conn, t: time.Now()&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> genericPool, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>又累又饿又困，后续有机会再补上测试吧</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>连接池的最基本的保证，就是获取连接时候的线程安全。但是在实现诸多额外特性时候却又从不同角度来实现。还是非常有意思的。但是不管存储结构是用 chan 还是还是 slice，都可以很好的实现这一点。如果像 sql 或者 redis 那样用 slice 来存储连接，就得维护一个结构来表示排队等候的效果。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.yangfan16.cn/go/go-state-machine/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="青梅煮马"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="青梅梦呓"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/go/go-state-machine/" class="post-title-link" itemprop="url">Go实现有限状态机</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-08-20 08:09:14" itemprop="dateCreated datePublished" datetime="2020-08-20T08:09:14+08:00">2020-08-20</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>7.3k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>有限状态机(FSM)是计算的基本概念，在现实生活中发现许多FSM行为，例如自动售货机，电梯，交通信号灯等。基于FSM的编程也是建模复杂状态转换的强大工具，它可以大大简化我们的程序。</p></blockquote><h3 id="什么是有限状态机"><a href="#什么是有限状态机" class="headerlink" title="什么是有限状态机"></a>什么是有限状态机</h3><blockquote><p>有限状态机（FSM）或简称为状态机，是计算的数学模型。它是一种抽象机器，在任何给定时间都可以恰好处于有限数量的状态之一。FSM可以响应某些输入而从一种状态更改为另一种状态。从一种状态到另一种状态的变化称为过渡。<br>— 维基百科</p></blockquote><p>FSM由三个关键元素组成：初始状态，所有可能状态的列表，触发状态转换的输入。<br>让我们将旋转栅栏作为FSM建模的简单示例。</p><div class="post-button"> <a class="btn" href="/go/go-state-machine/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.yangfan16.cn/go/go-map/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="青梅煮马"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="青梅梦呓"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/go/go-map/" class="post-title-link" itemprop="url">理解Go语言的哈希表</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-02 11:15:45" itemprop="dateCreated datePublished" datetime="2020-06-02T11:15:45+08:00">2020-06-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>7.7k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>哈希表是除了数组之外最常用的数据结构，几乎任何语言都有数组和哈希表这两个集合的实现，有些语言(比如<code>Python</code>) 将哈希表称之为字典，将数组称之为列表。但是它们是两种设计集合元素的思路，数组用于表示元素的序列，而哈希表示的是键值对之间映射关系，只是不同语言的叫法和实现稍微有些不同。Go语言中数组更常用到的是切片<code>slice</code>,哈希表则是<code>map</code></p></blockquote><div class="post-button"> <a class="btn" href="/go/go-map/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.yangfan16.cn/go/go-leetcode-slice/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="青梅煮马"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="青梅梦呓"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/go/go-leetcode-slice/" class="post-title-link" itemprop="url">数组算法训练</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-01 11:15:25" itemprop="dateCreated datePublished" datetime="2020-06-01T11:15:25+08:00">2020-06-01</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>2.3k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>准备认真练习算法题目，个人使用Go语言进行练习，这是算法系列文章的第一篇。</p></blockquote><div class="post-button"> <a class="btn" href="/go/go-leetcode-slice/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.yangfan16.cn/go/go-slice-array/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="青梅煮马"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="青梅梦呓"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/go/go-slice-array/" class="post-title-link" itemprop="url">理解Go语言数组和切片</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-30 10:10:45" itemprop="dateCreated datePublished" datetime="2020-05-30T10:10:45+08:00">2020-05-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>17k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>16 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>数组和切片是Go语言中常见的数据结构，很多刚刚使用Go的开发者往往会混淆这两个概念，数组作为最常见的集合在编程语言中是非常重要的，除了数组之外，Go 语言引入了另一个概念 — 切片，切片与数组有一些类似，但是它们的不同之处导致使用上会产生巨大的差别。我个人对于算法专项使用Go语言来进行练习，因此只涉及Go语言的部分实现和原理。</p></blockquote><div class="post-button"> <a class="btn" href="/go/go-slice-array/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.yangfan16.cn/go/actions-go/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="青梅煮马"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="青梅梦呓"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/go/actions-go/" class="post-title-link" itemprop="url">GitHub Actions 自动化构建Go应用</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-07 08:09:14" itemprop="dateCreated datePublished" datetime="2020-05-07T08:09:14+08:00">2020-05-07</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>3.9k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>欧老板昨天问我怎么让自己的go程序使用github-actions，给欧老板做了一个简单的demo， 一个beego的程序，随便写了点单测的代码。一个基本的 Pipeline，推送代码到 master 分支的时候就会触发该 Pipeline 的自动构建，进行代码的静态化检查操作、运行单元测试并使用 Codecov 生成代码覆盖率报告，部署到Netlify，并且根据Dockerfile生成Docker镜像。</p></blockquote><div class="post-button"> <a class="btn" href="/go/actions-go/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.yangfan16.cn/docker/docker-container/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="青梅煮马"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="青梅梦呓"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/docker/docker-container/" class="post-title-link" itemprop="url">重学Docker之容器（二）</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-05 17:12:43" itemprop="dateCreated datePublished" datetime="2020-05-05T17:12:43+08:00">2020-05-05</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>15k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>14 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>container是docker中最重要的，是打包代码及其所有依赖项的标准软件单元，因为container应用程序可以从一个计算环境快速可靠地运行到另一个计算环境。</p></blockquote><div class="post-button"> <a class="btn" href="/docker/docker-container/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.yangfan16.cn/docker/docker-images/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="青梅煮马"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="青梅梦呓"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/docker/docker-images/" class="post-title-link" itemprop="url">重学Docker之镜像（一）</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-05 10:10:45" itemprop="dateCreated datePublished" datetime="2020-05-05T10:10:45+08:00">2020-05-05</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.4k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>在写完podman体验的文章后，有几个朋友说作为开发还没开始使用Docker，就要去Docker,这世界变化太快。回过头想重新看一下Docker的使用，也体验一下最近docker带来的新的改变。谨做系列文章以记。</p></blockquote><div class="post-button"> <a class="btn" href="/docker/docker-images/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"> <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="青梅煮马" src="/uploads/avatar.png"><p class="site-author-name" itemprop="name">青梅煮马</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/yangfan16" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yangfan16" rel="noopener" target="_blank"><i class="github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:yangfan9915@gmail.com" title="E-Mail → mailto:yangfan9915@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://weibo.com/52012536" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;52012536" rel="noopener" target="_blank"><i class="weibo fa-fw"></i> Weibo</a></span></div><div class="cc-license motion-element" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="link fa-fw"></i> 大佬博客链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://think2011.net/" title="https:&#x2F;&#x2F;think2011.net&#x2F;" rel="noopener" target="_blank">曾浩的博客</a></li><li class="links-of-blogroll-item"> <a href="https://ninghao.net/blog" title="https:&#x2F;&#x2F;ninghao.net&#x2F;blog" rel="noopener" target="_blank">王皓的博客</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17005352号-2</a> <img src="/uploads/beian.png" style="display:inline-block"></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">青梅煮马</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-chart-area"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">104k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">1:35</span></div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e79f11b160a4070" async="async"></script></div></div></footer></div><script size="200" alpha="0.4" zindex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script><script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script><script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/lozad.js/1.14.0/lozad.min.js"></script><script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script><script data-pjax>CONFIG.page.isPost&&(wpac_init=window.wpac_init||[],wpac_init.push({widget:"Rating",id:10254,el:"wpac-rating",color:"fc6423"}),function(){if(!("WIDGETPACK_LOADED"in window)){WIDGETPACK_LOADED=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//embed.widgetpack.com/widget.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t.nextSibling)}}())</script><div id="pjax"></div></body></html>